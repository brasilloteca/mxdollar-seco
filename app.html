<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MX$ - Versão 1.0</title>

<style>
  :root { font-family: Inter, Segoe UI, Helvetica, Arial, sans-serif; }
  body { background:#f6f7fb; color:#111; margin:0; padding:0; }

  /* HEADER / LOGOUT */
  header {
    max-width:1200px;
    margin: 18px auto;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 1rem;
  }
  #logoutBtn {
    background:#ff4444;
    color:#fff;
    padding:0.6rem 1rem;
    border:none;
    border-radius:8px;
    cursor:pointer;
    display:none;
  }

  /* LOGIN / LOADING MESSAGE */
  #statusBox {
    text-align:center;
    margin-top:40px;
    font-size:1rem;
    color:#444;
  }

  /* CONTAINER DO APP */
  #app-wrapper {
    display:none;
    max-width:700px;
    margin:20px auto;
    background:#fff;
    padding:1.5rem;
    border-radius:16px;
    box-shadow:0 0 10px #ccc;
  }

  h1 { text-align:center; font-size:2rem; margin:1rem 0; }

  label { display:block; margin-top:1rem; font-weight:600; text-align:center; }
  input[type="number"], input[type="text"] {
    width:100%; padding:0.5rem; font-size:1rem; border:1px solid #ccc; border-radius:8px;
    text-align:center;
  }

  .row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; align-items:center; }
  button {
    width:100%; margin-top:1rem; padding:0.75rem; font-size:1rem;
    color:#fff; border:none; border-radius:8px; cursor:pointer;
  }
  #btnCalcular { background:#007bff; }
  #btnConcluir { background:#28a745; }
  #btnResetarHistorico { background:#dc3545; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; }
  th, td { border-bottom:1px solid #ddd; padding:0.5rem; text-align:center; font-size:0.9rem; }
  tr.win { background:#d4f8d4; }
  tr.lose { background:#f9d0d0; }
  #history { margin-top:1rem; max-height:300px; overflow:auto; }
  #lostBox { display:flex; align-items:center; gap:0.5rem; margin-top:1rem; }

  /* Responsivo */
  @media (max-width:800px) {
    .row { grid-template-columns:1fr; }
  }
</style>
</head>

<body>

<header>
  <div style="font-weight:700;">MX$ — App</div>
  <div>
    <button id="logoutBtn">Sair</button>
  </div>
</header>

<div id="statusBox">Carregando usuário...</div>

<div id="app-wrapper" role="main">
  <h1 id="titulo-app">MX$ - Versão 1.0</h1>

  <div class="row">
    <div>
      <label>Saldo inicial</label>
      <input type="number" id="saldoInicial" step="0.01" />
    </div>
    <div>
      <label>Saldo atual</label>
      <input type="text" id="saldoAtual" readonly />
    </div>
  </div>

  <label>Odd da aposta</label>
  <input type="number" id="oddA" step="0.01" />

  <label>Valor total da aposta</label>
  <input type="number" id="valorTotal" step="0.01" />

  <div id="mults" class="row">
    <div>
      <label>Red</label>
      <input type="number" id="multP1" step="0.01" />
    </div>
    <div>
      <label>Green</label>
      <input type="number" id="multV2" step="0.01" />
    </div>
  </div>

  <div id="lostBox">
    <input type="checkbox" id="chkPerdeu" />
    <label for="chkPerdeu">Aposta perdeu</label>
  </div>

  <button id="btnCalcular">Calcular Retorno</button>
  <button id="btnConcluir">Aposta concluída</button>

  <button id="btnResetarHistorico">Resetar histórico</button>

  <div id="resultado"></div>
  <div id="history"></div>
</div>

<!-- Supabase client (ESM) -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ---------- CONFIGURAÇÕES (CONFIRME ESTES VALORES) ----------
  const SUPABASE_URL = "https://ogosbyjhxjatukdhkiqw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nb3NieWpoeGphdHVrZGhraXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzIzMDUsImV4cCI6MjA4MDYwODMwNX0.-KbpngKGuRluFRdNcdKP14X13yUJIOzLaqjDyWAYHVc";
  // ------------------------------------------------------------

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Elementos do DOM
  const statusBox = document.getElementById('statusBox');
  const appWrapper = document.getElementById('app-wrapper');
  const logoutBtn = document.getElementById('logoutBtn');

  // Seus elementos do app (mantive nomes originais)
  const saldoInicialEl = document.getElementById('saldoInicial');
  const saldoAtualEl = document.getElementById('saldoAtual');
  const oddAEl = document.getElementById('oddA');
  const valorTotalEl = document.getElementById('valorTotal');
  const multP1El = document.getElementById('multP1');
  const multV2El = document.getElementById('multV2');
  const chkPerdeu = document.getElementById('chkPerdeu');
  const resultadoEl = document.getElementById('resultado');
  const historyEl = document.getElementById('history');

  let saldoInicial = 0;
  let history = [];
  let mults = { p1: 0, v2: 0 };

  // ---------- Autenticação / Sessão ----------
  async function initAuthAndApp() {
    try {
      // pega sessão atual
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        // não logado — redireciona para login
        window.location.href = 'login.html';
        return;
      }

      const user = session.user;
      statusBox.innerText = `Olá, ${user.email}. Verificando assinatura...`;

      // opcional: verificar assinatura ativa na tabela subscriptions
      const { data: subs, error: subErr } = await supabase
        .from('subscriptions')
        .select('*')
        .eq('user_id', user.id)
        .eq('status', 'active')
        .order('current_period_end', { ascending: false })
        .limit(1);

      if (subErr) {
        console.error('Erro ao checar assinatura:', subErr);
        // Não bloqueia o acesso por erro de consulta — você pode decidir o comportamento
      }

      const hasActiveSubscription = Array.isArray(subs) && subs.length > 0;

      if (!hasActiveSubscription) {
        // redireciona para a página de planos (modifique se o arquivo de planos tiver outro nome)
        statusBox.innerText = 'Nenhuma assinatura ativa encontrada. Redirecionando para planos...';
        setTimeout(() => { window.location.href = 'plans.html'; }, 1500);
        return;
      }

      // usuário validadado e com assinatura ativa — mostra app
      statusBox.style.display = 'none';
      appWrapper.style.display = 'block';
      logoutBtn.style.display = 'inline-block';

      // inicializa o app (carrega dados salvos)
      load();

    } catch (err) {
      console.error('Erro initAuthAndApp:', err);
      statusBox.innerText = 'Erro ao verificar sessão. Tente recarregar.';
    }
  }

  // logout
  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  };

  // observa mudanças de sessão (opcional)
  supabase.auth.onAuthStateChange((event, session) => {
    if (!session) {
      window.location.href = 'login.html';
    }
  });

  // ---------- Storage local e funções do app (mantive seu código com pequenas melhorias) ----------
  function save() {
    localStorage.setItem('mx$-saldoInicial', saldoInicial);
    localStorage.setItem('mx$-history', JSON.stringify(history));
    localStorage.setItem('mx$-mults', JSON.stringify(mults));
  }

  function load() {
    saldoInicial = parseFloat(localStorage.getItem('mx$-saldoInicial')) || 0;
    history = JSON.parse(localStorage.getItem('mx$-history') || '[]');
    try {
      mults = JSON.parse(localStorage.getItem('mx$-mults') || '{"p1":2.0,"v2":1.2}');
    } catch (e) {
      mults = { p1: 2.0, v2: 1.2 };
    }
    saldoInicialEl.value = saldoInicial.toFixed(2);
    multP1El.value = mults.p1;
    multV2El.value = mults.v2;
    renderHistory();
  }

  function renderHistory() {
    let saldoAtual = saldoInicial;
    let rows = history.map(h => {
      saldoAtual += h.resultado;
      const classe = h.resultado >= 0 ? 'win' : 'lose';
      return `<tr class="${classe}">
        <td>${h.data}</td>
        <td>${h.valor.toFixed(2)}</td>
        <td>${h.odd}</td>
        <td>${h.resultado.toFixed(2)}</td>
        <td>${saldoAtual.toFixed(2)}</td>
      </tr>`;
    }).join('');
    historyEl.innerHTML = `<table>
      <tr><th>Data</th><th>Valor</th><th>Odd</th><th>Resultado</th><th>Saldo</th></tr>
      ${rows}
    </table>`;
    saldoAtualEl.value = saldoAtual.toFixed(2);
  }

  document.getElementById('btnCalcular').onclick = () => {
    const odd = parseFloat(oddAEl.value);
    const valor = parseFloat(valorTotalEl.value);
    if (!odd || !valor) return alert('Preencha todos os campos');
    const ganho = valor * odd - valor;
    resultadoEl.innerHTML = `<p><b>Lucro em caso de acerto:</b> R$ ${ganho.toFixed(2)}</p>`;
  };

  document.getElementById('btnConcluir').onclick = () => {
    const odd = parseFloat(oddAEl.value);
    const valor = parseFloat(valorTotalEl.value);
    if (!odd || !valor) return alert('Preencha os campos');

    const perdeu = chkPerdeu.checked;
    const resultado = perdeu ? -valor : (valor * odd - valor);

    history.push({
      data: new Date().toLocaleString('pt-BR'),
      odd, valor, resultado
    });

    let mult = perdeu ? mults.p1 : mults.v2;

    let baseValor = valor;

    if (history.length >= 2) {
      const ultima = history[history.length - 1];
      const penultima = history[history.length - 2];
      if (ultima.resultado > 0 && penultima.resultado < 0) {
        const ultimaVencedora = [...history]
          .slice(0, history.length - 1)
          .reverse()
          .find(h => h.resultado > 0);
        baseValor = ultimaVencedora ? ultimaVencedora.valor : history[0].valor;
      }
    }

    valorTotalEl.value = (baseValor * mult).toFixed(2);
    oddAEl.value = '';
    chkPerdeu.checked = false;
    resultadoEl.innerHTML = '';
    renderHistory();
    save();
  };

  document.getElementById('btnResetarHistorico').onclick = () => {
    if (confirm('Deseja realmente apagar todo o histórico?')) {
      history = [];
      renderHistory();
      save();
    }
  };

  saldoInicialEl.oninput = () => { saldoInicial = parseFloat(saldoInicialEl.value) || 0; save(); };
  multP1El.oninput = () => { mults.p1 = parseFloat(multP1El.value) || 1; save(); };
  multV2El.oninput = () => { mults.v2 = parseFloat(multV2El.value) || 1; save(); };

  // inicialização
  initAuthAndApp();

</script>

</body>
</html>
